context("lmm regression test")

test_that("fitLMM works", {

    tol <- 1e-8 # tolerance for convergence

    # load test data
    data(recla)
    k <- recla$kinship
    y <- recla$pheno
    X <- recla$covar

    # scale phenotypes to have sd 1
    y <- t( t(y) / apply(y, 2, sd, na.rm=TRUE) )

    # analyses all phenotypes by reml
    lmm_all_r <- lapply(1:ncol(y), function(i) {
        thisy <- y[,i,drop=FALSE]
        omit <- is.na(thisy)
        thisy <- thisy[!omit,,drop=FALSE]
        thisX <- X[!omit,,drop=FALSE]
        thisk <- k[!omit,!omit]
        e <- eigen_rotation(thisk, thisy, thisX)
        fitLMM(e$Kva, e$y, e$X, tol=tol)})

    # combine results
    tab_lmm_r <- t(vapply(lmm_all_r, function(a) c(sigsq_g=a$sigsq_g,
                                                   sigsq_e=a$sigsq_e,
                                                   hsq=a$hsq,
                                                   beta_int=a$beta[1],
                                                   beta_sex=a$beta[2],
                                                   loglik=a$loglik),
                          rep(0, 6)))


    # expected results
    expected_lmm_r <- structure(c(0.862760198678552, 1.14845584449392, 0.212365970091274,
                                  0.0145121886224065, 1.09243203699448, 0.00000000374534998643573,
                                  1.11283493796972, 0.551130846152176, 0.149688280555557, 0.800267791479883,
                                  0.532175882391754, 1.10568492973929, 0.802981522372937, 1.09871155581139,
                                  1.09808453135421, 1.07710759069931, 1.10857327834404, 1.09702826070653,
                                  1.09145723997148, 0.486026352247205, 0.978667472549318, 0.67241829905247,
                                  0.823492712149327, 0.446834401332294, 0.00000000373320773036617,
                                  0.484879849694674, 0.266068150837228, 0.0000000344000652247725,
                                  0.817673250938945, 0.968747811443615, 0.0000000327219662004516,
                                  1.00205046306844, 0.0000000333331008188941, 0.502489519863102,
                                  0.870008917912044, 0.304489736964665, 0.528486652316729, 0.0000000331189343355559,
                                  0.280085878200525, 0.0577321741907678, 0.0000000328912771718657,
                                  0.0000000322629481593011, 0.0000000332054499651047, 0.000000032859638359325,
                                  0.0634686838194544, 0.583226206995366, 0.14422942800986, 0.406307425735709,
                                  0.297666522077834, 0.611701193377648, 0.998801860571678, 0.0000000145237612187214,
                                  0.76429706876926, 0.999999970046681, 0.206172702704341, 0.0147592586105731,
                                  0.999999970046681, 0.00000000373768598536237, 0.999999970046681,
                                  0.523082947073732, 0.146796794950999, 0.724383198009636, 0.501739115861219,
                                  0.999999970046681, 0.741395708104384, 0.950077835442404, 0.999999970046681,
                                  0.999999970046681, 0.999999970046681, 0.999999970046681, 0.945045234060446,
                                  0.454547756791429, 0.871555947889751, 0.623345011248812, 0.734501119028804,
                                  0.422125059908576, 0.00000000373768598536237, 0.999999970046681,
                                  2.77218848460837, 3.07830194303598, 3.40615081643807, 1.62773197210201,
                                  7.61524597843783, 0.932611774210445, 2.04852995901848, 2.1695273860172,
                                  2.02277342962158, 2.27311490291016, 3.71518277447378, 3.98523414898093,
                                  3.49996278541324, 3.75324862243968, 2.75842372627376, 1.77786238998925,
                                  1.65011250715237, 2.07043816031364, 1.8096984450582, 0.993508695268034,
                                  1.83734817263996, 1.99414657399373, 0.42420100243153, 2.18858159507117,
                                  0.803648785217822, 3.6884815019753, -0.0454385431341057, 0.0268702500360297,
                                  -0.131916606583104, -0.298943374467943, 0.346277245853301, -0.0848245897333177,
                                  0.000145372190272053, -0.23093476799451, 0.122465650280794, 0.156634307640488,
                                  -0.19228919103815, 0.0487692541517228, -0.167432150580726, -0.111909686778942,
                                  -0.0525335587120378, -0.214629916058912, -0.0325420153736749,
                                  -0.131306197914022, 0.115165883040778, -0.0716639861739202, -0.29267272740739,
                                  -0.272243775276856, -0.150441961964645, 0.041098004582754, -0.142211014750835,
                                  1.42557894703518, -717.36543392394, -709.418741330077, -722.897901569321,
                                  -720.879424645344, -702.942205613331, -723.593448507922, -705.338515083443,
                                  -717.006091655392, -713.114315040129, -706.417790512293, -708.816703603788,
                                  -695.052386566824, -703.277728962375, -703.08076657326, -694.169485820958,
                                  -691.70061732983, -695.386321272136, -694.046300667259, -703.137566586369,
                                  -711.280681974735, -702.717286014442, -716.699340702028, -711.18856371976,
                                  -714.197176248473, -716.613423119153, -597.754459379841), .Dim = c(26L,
                                                                                            6L), .Dimnames = list(NULL, c("sigsq_g", "sigsq_e", "hsq", "beta_int",
                                                                                                 "beta_sex", "loglik")))


    # compare
    expect_equal(tab_lmm_r, expected_lmm_r)


    # analyses all phenotypes by ML
    lmm_all_m <- lapply(1:ncol(y), function(i) {
        thisy <- y[,i,drop=FALSE]
        omit <- is.na(thisy)
        thisy <- thisy[!omit,]
        thisX <- X[!omit,]
        thisk <- k[!omit,!omit]
        e <- eigen_rotation(thisk, thisy, thisX)
        fitLMM(e$Kva, e$y, e$X, tol=tol, reml=FALSE)})

    # combine results
    tab_lmm_m <- t(vapply(lmm_all_m, function(a) c(sigsq_g=a$sigsq_g,
                                                   sigsq_e=a$sigsq_e,
                                                   hsq=a$hsq,
                                                   beta_int=a$beta[1],
                                                   beta_sex=a$beta[2],
                                                   loglik=a$loglik),
                          rep(0, 6)))

    # expected results
    expected_lmm_m <- structure(c(0.802987167040159, 1.11827766121546, 0.00000000373597830961612,
                                  0.00000000366778699986858, 1.09243203699448, 0.00000000374534998643573,
                                  1.11283493796972, 0.499794867878868, 0.00000000373906513113172,
                                  0.75169868681324, 0.48172586898868, 1.10568492973929, 0.766672454107718,
                                  1.05681373327737, 1.09808453135421, 1.07710759069931, 1.10857327834404,
                                  1.09702826070653, 1.04953283379738, 0.420859502143819, 0.933022017976629,
                                  0.616782251980367, 0.756348291212714, 0.38783344465212, 0.00000000373320773036617,
                                  0.484879849694674, 0.311411376681597, 0.0221463032459765, 0.999543115789596,
                                  0.981298857240399, 0.0000000327219662004516, 1.00205046306844,
                                  0.0000000333331008188941, 0.542863841947755, 1.00036898011211,
                                  0.341565690161404, 0.568355699539156, 0.0000000331189343355559,
                                  0.307731522726233, 0.088741068403484, 0.0000000328912771718657,
                                  0.0000000322629481593011, 0.0000000332054499651047, 0.000000032859638359325,
                                  0.0945182157171083, 0.635196009960131, 0.178378362893476, 0.449388207136839,
                                  0.348898811086228, 0.658982552820446, 0.998801860571678, 0.0000000145237612187214,
                                  0.720556547353717, 0.98058064023897, 0.00000000373768598536237,
                                  0.00000000373768598536237, 0.999999970046681, 0.00000000373768598536237,
                                  0.999999970046681, 0.47934656198477, 0.00000000373768598536237,
                                  0.687572651816747, 0.45875090414551, 0.999999970046681, 0.713579315265516,
                                  0.922534418891811, 0.999999970046681, 0.999999970046681, 0.999999970046681,
                                  0.999999970046681, 0.917382868747667, 0.398520245687987, 0.839501258085025,
                                  0.578502477447242, 0.68432506146317, 0.37048864899706, 0.00000000373768598536237,
                                  0.999999970046681, 2.77092440627229, 3.07626166636147, 3.40478291866823,
                                  1.62731948089372, 7.61524597843783, 0.932611774210445, 2.04852995901848,
                                  2.16550015326782, 2.00521465489992, 2.27060773310471, 3.71333937974881,
                                  3.98523414898093, 3.49787427518602, 3.75591938226404, 2.75842372627376,
                                  1.77786238998925, 1.65011250715237, 2.07043816031364, 1.80703251202696,
                                  0.994391785905759, 1.83338301122512, 1.99616151411862, 0.420289937768795,
                                  2.1881759077938, 0.803648785217822, 3.6884815019753, -0.0468912850974654,
                                  0.0268182040096678, -0.130994632514428, -0.29943885720179, 0.346277245853301,
                                  -0.0848245897333177, 0.000145372190272053, -0.235395275825501,
                                  0.118544906345586, 0.155841947819734, -0.191470669918674, 0.0487692541517228,
                                  -0.16691199119656, -0.11279674833963, -0.0525335587120378, -0.214629916058912,
                                  -0.0325420153736749, -0.131306197914022, 0.116050477172621, -0.0718913978418514,
                                  -0.291500920045416, -0.271631506292648, -0.154395037158212, 0.0447538941885513,
                                  -0.142211014750835, 1.42557894703518, -720.850337242626, -713.005698950792,
                                  -725.106425525457, -722.70245478952, -706.483475248259, -725.433374007404,
                                  -708.898289038603, -720.282696293113, -715.375480475209, -709.86210088569,
                                  -712.078913802753, -698.601688983122, -706.712569405118, -706.654640590078,
                                  -697.711890575179, -695.223734048965, -698.938232553319, -697.587743037467,
                                  -706.708749745274, -714.503558651465, -706.237066443981, -720.066701880965,
                                  -714.649624587561, -717.383324924947, -718.45010139659, -600.483468426093
                                  ), .Dim = c(26L, 6L), .Dimnames = list(NULL, c("sigsq_g", "sigsq_e",
                                                        "hsq", "beta_int", "beta_sex", "loglik")))

    # compare
    expect_equal(tab_lmm_m, expected_lmm_m)
})
