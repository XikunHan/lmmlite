context("lmm regression test")

# function to load the test data
load_test_data <-
    function()
{
    dir <- tempdir()

    utils::unzip(system.file("extdata", "recla.zip", package="lmmlite"), exdir=dir)
    dir <- file.path(dir, "Recla")

    read_csv <-
        function(dir, file)
        {
            tmp <- data.table::fread(file.path(dir, file), header=TRUE, data.table=FALSE)
            rownames(tmp) <- tmp[,1]
            as.matrix(tmp[,-1,drop=FALSE])
        }

    k <- read_csv(dir, "kinship.csv")
    y <- read_csv(dir, "pheno.csv")

    # covariates, adding intercept column
    X <- read_csv(dir, "covar.csv")
    X <- cbind(intercept=1, sex=X)

    list(k=k, y=y, X=X)
}


test_that("fitLMM works", {

    tol <- 1e-8 # tolerance for convergence

    # load test data
    dat <- load_test_data()
    k <- dat$k
    y <- dat$y
    X <- dat$X

    # scale phenotypes to have sd 1
    y <- t( t(y) / apply(y, 2, sd, na.rm=TRUE) )

    # LMM by REML and ML with regress package
    library(regress)
    out1r <- regress(y[,1] ~ -1 + X, ~k, tol=tol)

    # LMM with lmm.R
    e <- eigen_rotation(k, y[,1], X)
    lmm1r <- fitLMM(e$Kva, e$y, e$X, tol=tol)

    # compare results
    expect_equal(out1r$sigma, c(k=lmm1r$sigsq_g, In=lmm1r$sigsq_e),
                 tolerance=0.00001)
    rownames(out1r$beta) <- gsub("^X", "", rownames(out1r$beta))
    expect_equal(out1r$beta, lmm1r$beta, tolerance=0.00001)

    # analyses all phenotypes by reml
    lmm_all_r <- lapply(1:ncol(y), function(i) {
        thisy <- y[,i,drop=FALSE]
        omit <- is.na(thisy)
        thisy <- thisy[!omit,,drop=FALSE]
        thisX <- X[!omit,,drop=FALSE]
        thisk <- k[!omit,!omit]
        e <- eigen_rotation(thisk, thisy, thisX)
        fitLMM(e$Kva, e$y, e$X, tol=tol)})

    # combine results
    tab_lmm_r <- t(vapply(lmm_all_r, function(a) c(sigsq_g=a$sigsq_g,
                                                   sigsq_e=a$sigsq_e,
                                                   hsq=a$hsq,
                                                   beta_int=a$beta[1],
                                                   beta_sex=a$beta[2],
                                                   loglik=a$loglik),
                          rep(0, 6)))


    # analyses all phenotypes by ML
    lmm_all_m <- lapply(1:ncol(y), function(i) {
        thisy <- y[,i,drop=FALSE]
        omit <- is.na(thisy)
        thisy <- thisy[!omit,]
        thisX <- X[!omit,]
        thisk <- k[!omit,!omit]
        e <- eigen_rotation(thisk, thisy, thisX)
        fitLMM(e$Kva, e$y, e$X, tol=tol, reml=FALSE)})

    tab_lmm_m <- t(vapply(lmm_all_m, function(a) c(sigsq_g=a$sigsq_g,
                                                   sigsq_e=a$sigsq_e,
                                                   hsq=a$hsq,
                                                   beta_int=a$beta[1],
                                                   beta_sex=a$beta[2],
                                                   loglik=a$loglik),
                          rep(0, 6)))


    # expected results
    expected_lmm_r <- structure(c(0.862760228405141, 1.14845584449392, 0.21236622943567,
                                  0.01451226487728, 1.09243203699448, 0.00000000374534998643574,
                                  1.11283493796972, 0.551130949314297, 0.149688210331473, 0.800267894169103,
                                  0.532175959593832, 1.10568492973929, 0.802981586132658, 1.09871144388236,
                                  1.09808453135421, 1.07710759069931, 1.10857327834404, 1.09702826070653,
                                  1.09145726069178, 0.486026336717328, 0.978667472547611, 0.672418274080871,
                                  0.823493018334657, 0.446834439055664, 0.00000000373320773036618,
                                  0.484879849694676, 0.266068128410619, 0.0000000344000652247725,
                                  0.81767303717394, 0.968747745783691, 0.0000000327219662004516,
                                  1.00205046306844, 0.0000000333331008188941, 0.502489439325136,
                                  0.870008976531329, 0.304489658985435, 0.528486591766725, 0.000000033118934335556,
                                  0.280085829872061, 0.0577322567285625, 0.0000000328912771718657,
                                  0.0000000322629481593011, 0.0000000332054499651047, 0.000000032859638359325,
                                  0.0634686685300971, 0.583226219264403, 0.144229428011133, 0.406307444946499,
                                  0.297666289887113, 0.611701163433141, 0.998801860571679, 0.0000000145237612187214,
                                  0.764297090160674, 0.999999970046681, 0.206172945362245, 0.014759336004649,
                                  0.999999970046681, 0.00000000373768598536237, 0.999999970046681,
                                  0.523083033753728, 0.146796727754053, 0.724383274759252, 0.501739180770724,
                                  0.999999970046681, 0.741395756410753, 0.950077762801541, 0.999999970046681,
                                  0.999999970046681, 0.999999970046681, 0.999999970046681, 0.945045247557254,
                                  0.454547743653588, 0.871555947888568, 0.623344991428549, 0.734501343650056,
                                  0.422125092443823, 0.00000000373768598536237, 0.999999970046681,
                                  2.77218848522655, 3.07830194303598, 3.4061508173997, 1.62773197422799,
                                  7.61524597843783, 0.932611774210445, 2.04852995901848, 2.16952739384391,
                                  2.02277342220666, 2.27311490818692, 3.71518277718356, 3.98523414898093,
                                  3.49996278901963, 3.75324862947945, 2.75842372627376, 1.77786238998925,
                                  1.65011250715237, 2.07043816031364, 1.80969844635813, 0.99350869547362,
                                  1.83734817263981, 1.9941465749232, 0.424201020217319, 2.1885815952895,
                                  0.803648785217822, 3.6884815019753, -0.0454385424364395, 0.0268702500360297,
                                  -0.131916607265713, -0.298943371874186, 0.346277245853301, -0.0848245897333177,
                                  0.000145372190272042, -0.230934759212866, 0.122465648886347,
                                  0.156634309254159, -0.192289192351347, 0.0487692541517228, -0.167432151507217,
                                  -0.111909689126274, -0.0525335587120378, -0.214629916058912,
                                  -0.032542015373675, -0.131306197914022, 0.115165882607713, -0.0716639862213787,
                                  -0.292672727407347, -0.272243775009952, -0.150441944490882, 0.0410980023203943,
                                  -0.142211014750835, 1.42557894703518, -719.20331099035, -711.256618396486,
                                  -724.735778635731, -722.717301711754, -704.780082679741, -725.431325574331,
                                  -707.176392149852, -718.843968721801, -714.952192106539, -708.255667578702,
                                  -710.654580670198, -696.890263633234, -705.115606028784, -704.91864363967,
                                  -696.007362887368, -693.53849439624, -697.224198338545, -695.884177733668,
                                  -704.975443652779, -713.118559041145, -704.555163080851, -718.537217768437,
                                  -713.026440786169, -716.035053314882, -718.451300185563, -599.592336446251
                                  ), .Dim = c(26L, 6L), .Dimnames = list(NULL, c("sigsq_g", "sigsq_e",
                                                        "hsq", "beta_int", "beta_sex", "loglik")))

    expected_lmm_m <- structure(c(0.796833960834209, 1.10970848012991, 0.00000000370735012333556,
                                  0.00000000363968135236, 1.08406091027421, 0.00000000371664998653968,
                                  1.10430746718068, 0.495965151690246, 0.00000000371008013011523,
                                  0.745871461485014, 0.477991735948588, 1.09711372873356, 0.760729220308186,
                                  1.04862136723265, 1.08957224816542, 1.06875791945358, 1.09997968703905,
                                  1.08852416566229, 1.04139692155897, 0.417597058591154, 0.925789288628409,
                                  0.612055859200416, 0.750507624344982, 0.384838457501459, 0.00000000370437987144443,
                                  0.481164295290885, 0.309025119101088, 0.0219766024251539, 0.991883781568993,
                                  0.973779325767289, 0.0000000324712231644328, 0.994371915458725,
                                  0.0000000330776747589792, 0.538703863111205, 0.992614181816674,
                                  0.338917973717945, 0.56394970121514, 0.0000000328621984104741,
                                  0.305346034949946, 0.0880531617044449, 0.0000000326363060309985,
                                  0.0000000320128477859732, 0.0000000329480433762279, 0.0000000326049124805705,
                                  0.0937855154770298, 0.630271983143327, 0.17699558528228, 0.445944691056059,
                                  0.346204718901549, 0.653893993139672, 0.991089104891589, 0.0000000144124680293059,
                                  0.720556511486826, 0.980580637878926, 0.00000000373768598536237,
                                  0.00000000373768598536237, 0.999999970046681, 0.00000000373768598536237,
                                  0.999999970046681, 0.479346674729039, 0.00000000373768598536237,
                                  0.687572571487539, 0.458751057304843, 0.999999970046681, 0.713579286786831,
                                  0.922534411159206, 0.999999970046681, 0.999999970046681, 0.999999970046681,
                                  0.999999970046681, 0.917382869557155, 0.398520274919019, 0.839501257707118,
                                  0.57850240158386, 0.684324954457338, 0.37048852884487, 0.00000000373768598536237,
                                  0.999999970046681, 2.77092440523507, 3.07626166611466, 3.40478291866823,
                                  1.62731948089372, 7.61524597843783, 0.932611774210445, 2.04852995901848,
                                  2.16550016385692, 2.00521465489992, 2.27060772768315, 3.71333938649698,
                                  3.98523414898093, 3.49787427303533, 3.75591938301431, 2.75842372627376,
                                  1.77786238998925, 1.65011250715237, 2.07043816031364, 1.80703251210503,
                                  0.994391785441863, 1.83338301117854, 1.99616151737989, 0.420289929555173,
                                  2.18817590671038, 0.803648785217822, 3.6884815019753, -0.0468912863104323,
                                  0.0268182040015491, -0.130994632514427, -0.29943885720179, 0.346277245853301,
                                  -0.0848245897333177, 0.000145372190272042, -0.235395264245433,
                                  0.118544906345586, 0.155841946049093, -0.191470672651274, 0.0487692541517228,
                                  -0.166911990677652, -0.112796748587829, -0.0525335587120378,
                                  -0.214629916058912, -0.032542015373675, -0.131306197914022, 0.116050477146823,
                                  -0.0718913977105801, -0.291500920031727, -0.271631505242509,
                                  -0.154395045697368, 0.044753902853077, -0.142211014750835, 1.42557894703518,
                                  -720.850337242627, -713.005698950792, -725.106425525458, -722.70245478952,
                                  -706.483475248259, -725.433374007405, -708.898289038603, -720.282696293113,
                                  -715.37548047521, -709.86210088569, -712.078913802753, -698.601688983123,
                                  -706.712569405118, -706.654640590078, -697.711890575179, -695.223734048965,
                                  -698.938232553319, -697.587743037467, -706.708749745275, -714.503558651465,
                                  -706.237066443981, -720.066701880965, -714.649624587562, -717.383324924948,
                                  -718.45010139659, -600.483468426094), .Dim = c(26L, 6L), .Dimnames = list(
                                                                                           NULL, c("sigsq_g", "sigsq_e", "hsq", "beta_int", "beta_sex",
                                                                                                   "loglik")))


    expect_equal(tab_lmm_r, expected_lmm_r)
    expect_equal(tab_lmm_m, expected_lmm_m)
})
